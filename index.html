<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Analytics</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:760px;margin:40px auto;padding:0 16px;line-height:1.6}
    .card{border:1px solid #ddd;border-radius:12px;padding:18px;margin:14px 0}
    button,a.btn{display:inline-block;padding:12px 16px;border-radius:10px;border:1px solid #222;background:#111;color:#fff;text-decoration:none;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .muted{color:#666;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{padding:10px 12px;border-radius:10px;border:1px solid #ccc;min-width:320px}
    .ok{color:#0a7; font-weight:600}
    .ng{color:#d33; font-weight:600}
    pre{background:#f7f7f7;padding:12px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>
  <h1>TikTok Analytics</h1>
  <p class="muted">
    このページは静的サイト（GitHub Pages）です。TikTok OAuthとデータ取得はバックエンド（Flask）で行います。
  </p>

  <div class="card">
    <h2>バックエンドURL設定</h2>
    <p class="muted">ローカル実行なら <code>http://localhost:5000</code>。本番はあなたのサーバーURLに変更。</p>
    <div class="row">
      <input id="backendBase" value="http://localhost:5000" />
      <button class="secondary" id="saveBtn">保存</button>
    </div>
    <p id="savedMsg" class="muted"></p>
  </div>

  <div class="card">
    <h2>① TikTok Login</h2>
    <p>まずログインして、アクセストークンを取得します（バックエンドで保存）。</p>
    <div class="row">
      <a class="btn" id="loginBtn" href="#">Login with TikTok</a>
      <button class="secondary" id="statusBtn">Login状態確認</button>
    </div>
    <p id="status" class="muted"></p>
  </div>

  <div class="card">
    <h2>② データ取得 → CSV生成</h2>
    <p class="muted">
      バックエンドが TikTok API から <b>views / likes / comments / shares</b> と <b>follower count</b> を取得し、CSVを返します。
    </p>
    <div class="row">
      <button id="downloadBtn">Download CSV</button>
    </div>
    <p class="muted">※ 事前にログインが必要です。</p>
    <div id="logWrap" style="display:none">
      <h3>ログ</h3>
      <pre id="log"></pre>
    </div>
  </div>

<script>
  const KEY = "TIKTOK_ANALYTICS_BACKEND_BASE";

  function getBackendBase(){
    return localStorage.getItem(KEY) || document.getElementById("backendBase").value.trim();
  }
  function setBackendBase(v){
    localStorage.setItem(KEY, v);
    document.getElementById("backendBase").value = v;
    document.getElementById("savedMsg").textContent = `保存しました: ${v}`;
  }
  function log(msg){
    document.getElementById("logWrap").style.display = "block";
    const el = document.getElementById("log");
    el.textContent += msg + "\n";
  }

  // load saved
  const saved = localStorage.getItem(KEY);
  if(saved) document.getElementById("backendBase").value = saved;

  document.getElementById("saveBtn").addEventListener("click", ()=>{
    setBackendBase(document.getElementById("backendBase").value.trim());
  });

  document.getElementById("loginBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    const base = getBackendBase();
    window.location.href = `${base}/login`;
  });

  document.getElementById("statusBtn").addEventListener("click", async ()=>{
    const base = getBackendBase();
    document.getElementById("status").textContent = "checking...";
    try{
      const res = await fetch(`${base}/status`, { credentials: "include" });
      const data = await res.json();
      document.getElementById("status").innerHTML =
        data.logged_in ? `<span class="ok">Logged in</span> (${data.display_name || "unknown"})`
                       : `<span class="ng">Not logged in</span>`;
    }catch(err){
      document.getElementById("status").innerHTML = `<span class="ng">Error</span> ${err}`;
    }
  });

  document.getElementById("downloadBtn").addEventListener("click", async ()=>{
    const base = getBackendBase();
    log("Requesting CSV...");
    try{
      // 直接ダウンロードさせる（fetchだとファイル扱いが面倒なので location で）
      window.location.href = `${base}/export_csv`;
    }catch(err){
      log("ERROR: " + err);
    }
  });
</script>
</body>
</html>
